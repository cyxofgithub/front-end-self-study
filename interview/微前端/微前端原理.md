微前端是一种架构模式，用于将多个独立开发、独立部署的前端子应用集成到同一个主应用中运行。其核心原理主要包括：**包裹应用沙箱（隔离运行环境）**、**样式隔离**、**通信机制**三大部分。

---

### 1. 包裹应用沙箱（运行时隔离）

微前端中的每个子应用，都需要在自己的“沙箱”环境中运行，防止全局变量、window 属性等互相污染。常用方案包括：

-   **JS 沙箱**  
     利用`with`语句、`Proxy`代理子应用 JS 执行上下文，拦截和隔离 window/global 的访问。
    **with 语句简介：**  
    `with` 语句是 JavaScript 的一种语法结构，可以临时将一个对象的属性添加到作用域链顶端。这样在 `with` 语句块内部，可以直接访问对象的属性，比如：

```javascript
const obj = { a: 1, b: 2 };
with (obj) {
    console.log(a); // 输出 1，相当于 obj.a
    console.log(b); // 输出 2
}
```

在微前端原理中，`with` 语句可以用来隔离 JS 沙箱中的作用域，使得子应用的全局变量不会直接污染主应用的全局作用域。不过，`with` 语句存在不推荐使用和被严格模式禁用的问题，现代微前端框架通常会结合 Proxy 等其它方式实现沙箱隔离。

-   **iframe 沙箱**  
    原生 iframe 可实现更彻底的隔离，但资源加载慢、体验差，不常用在现代微前端。
-   **如 qiankun 采用的快照隔离**  
    加载、切换应用时，记录和恢复 window 的状态，避免副作用泄漏。

---

### 2. 样式隔离

为避免子应用之间的 CSS 冲突，微前端会做样式隔离，常见方式有：

-   **CSS 前缀/作用域**  
    构建时自动为子应用所有 CSS 选择器加命名空间前缀（如 shadow-root 样式或约定父节点类名）。
-   **Shadow DOM**  
    原生 Web Component 的 shadow DOM，实现样式的强隔离，不过兼容性和改造成本较高。
-   **动态样式处理**  
    运行时修改 style 标签内容、scoped CSS、CSS-in-JS 等变通隔离方式。
-   **如 qiankun：严格模式下自动处理 style 标签和 DOM 选择器，仅作用于该子应用区域。**

---

### 3. 通信机制

多个子应用间往往需要状态同步、事件通知等通信：

-   **全局事件总线（Event Bus）**  
    主应用或独立通信模块暴露发布/订阅接口（如 on、emit、off），用于应用之间互发事件。
-   **props 参数传递**  
    主应用在加载子应用时将必要数据通过参数、全局对象等传递下去。
-   **自定义协议或第三方状态管理**  
    使用 window/sharedWorker/postMessage 或 redux、mobx 等第三方状态方案，在主应用和子应用共享状态。

---

**总结：**

微前端的本质是在主应用的统一调度下，实现多个前端子项目的“低耦合融合”，通过 JS 沙箱与样式隔离保证运行互不干扰，通过多样通信机制保证业务协同。所谓“像搭积木一样拼装整个前端产品”。
