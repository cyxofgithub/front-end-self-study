## setState 执行机制

### setState 为什么默认是异步

假如所有 setState 是同步的，意味着每执行一次 setState 时，都重新 vnode diff + dom 修改，这对性能来说是极为不好的。如果是异步，则可以把一个同步代码中的多个 setState 合并成一次组件更新。

### 什么时候是同步

在 class 组件中 setTimeout、原生 dom 事件中是同步的

### 原因

1、在 React 源码中，当调用 setState 时，会将状态更新添加到更新队列中。然后，React 会通过调用 batchedUpdates 方法，将更新队列中的所有状态更新进行批处理，并在合适的时机进行更新。

2、在合成事件中，React 会将事件处理函数包装在 batchedUpdates 方法中，以确保在事件处理函数执行期间的所有 setState 调用都被批处理。这样可以避免不必要的重渲染。因此，在合成事件中调用 setState 后，状态更新会被添加到更新队列中，并等待合适的时机进行异步更新。

3、而在原生事件中，React 无法控制事件的触发和处理过程，因此无法对事件处理函数进行包装。当在原生事件中调用 setState 时，React 会立即更新状态，并且在更新完成后，可以直接打印出结果。

### React 中 setState 后发生了什么

在代码中调用 setState 函数之后，React 会将传入的参数对象与组件当前的状态合并，然后触发所谓的调和过程（Reconciliation）。

经过调和过程，react 会得到虚拟树，进行 diff 比对，计算出新的树与老树的节点差异，然后根据差异对界面进行最小化重渲染。
