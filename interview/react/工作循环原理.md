### React Fiber æ¶æ„

React Fiber æ˜¯ä¸€ç§é‡æ–°å®ç°çš„åè°ƒç®—æ³•ï¼Œå®ƒä½¿å¾— React å¯ä»¥æ›´ç»†ç²’åº¦åœ°æ§åˆ¶æ¸²æŸ“å·¥ä½œï¼Œä»è€Œæé«˜åº”ç”¨çš„å“åº”æ€§å’Œæ€§èƒ½ã€‚Fiber å…è®¸ React å°†æ¸²æŸ“å·¥ä½œåˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œå¹¶åœ¨æ¯ä¸ªä»»åŠ¡ä¹‹é—´æ£€æŸ¥ä¸»çº¿ç¨‹æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡éœ€è¦å¤„ç†ã€‚

### å·¥ä½œå¾ªç¯çš„ä¸»è¦æ­¥éª¤

1. **ä»»åŠ¡åˆ†å‰²**ï¼šå°†æ¸²æŸ“å·¥ä½œåˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶çš„æ›´æ–°ã€‚
2. **ä»»åŠ¡è°ƒåº¦**ï¼šè°ƒåº¦å™¨æ ¹æ®ä»»åŠ¡çš„ä¼˜å…ˆçº§å’Œæµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ¥è°ƒåº¦ä»»åŠ¡çš„æ‰§è¡Œã€‚
3. **è®©å‡ºä¸»çº¿ç¨‹**ï¼šåœ¨æ¯ä¸ªä»»åŠ¡ä¹‹é—´ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥ä¸»çº¿ç¨‹æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡éœ€è¦å¤„ç†ã€‚å¦‚æœæœ‰ï¼ŒReact ä¼šæš‚åœå½“å‰çš„æ¸²æŸ“å·¥ä½œï¼Œè®©å‡ºä¸»çº¿ç¨‹ã€‚
4. **æ¢å¤å·¥ä½œ**ï¼šå½“ä¸»çº¿ç¨‹ç©ºé—²æ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ¢å¤ä¹‹å‰æš‚åœçš„æ¸²æŸ“å·¥ä½œï¼Œç»§ç»­å¤„ç†å‰©ä½™çš„ä»»åŠ¡ã€‚

### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº† React å·¥ä½œå¾ªç¯çš„åŸºæœ¬åŸç†ï¼š

```javascript
let sum = 0;
const currentIndex = 0; // å½“å‰éå†çš„ç´¢å¼•
const totalCount = 20000000;

const getCurrentTime = () => Date.now();

const channel = new MessageChannel();
const port = channel.port2;
channel.port1.onmessage = performWorkUntilDeadline;

// è°ƒåº¦åº”è¯¥è¢«ä¸­æ–­å—
function shouldYieldToHost(startTime) {
    const timeElapsed = getCurrentTime() - startTime;
    // å¦‚æœå½“å‰æ—¶é—´å‡å»å¼€å§‹æ—¶é—´å°äº 5ms, é‚£ä¹ˆç»§ç»­è°ƒåº¦
    if (timeElapsed < 5) {
        return false;
    }
    return true;
}

const performWorkUntilDeadline = () => {
    const startTime = getCurrentTime();
    const hasMoreWork = workLoop(startTime);

    if (hasMoreWork) {
        port.postMessage(null);
    }
};

const workLoop = startTime => {
    while (true) {
        work(startTime);

        if (currentIndex < totalCount) {
            return true;
        } else {
            return false;
        }
    }
};

const work = startTime => {
    for (; currentIndex < totalCount && !shouldYieldToHost(startTime); currentIndex++) {
        sum += currentIndex;
    }
};

performWorkUntilDeadline();
```

### æ€»ç»“

React çš„å·¥ä½œå¾ªç¯é€šè¿‡ React Fiber æ¶æ„å®ç°ï¼Œä¸»è¦æ­¥éª¤åŒ…æ‹¬ï¼š

1. å°†æ¸²æŸ“å·¥ä½œåˆ†æˆå¤šä¸ªå°ä»»åŠ¡ã€‚
2. ä½¿ç”¨è°ƒåº¦å™¨æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§å’Œæµè§ˆå™¨ç©ºé—²æ—¶é—´æ¥è°ƒåº¦ä»»åŠ¡ã€‚
3. åœ¨æ¯ä¸ªä»»åŠ¡ä¹‹é—´æ£€æŸ¥ä¸»çº¿ç¨‹æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡éœ€è¦å¤„ç†ã€‚
4. ä½¿ç”¨ MessageChannel ç­‰æµè§ˆå™¨ API æ¥å®ç°æ—¶é—´åˆ‡ç‰‡å’Œä»»åŠ¡è°ƒåº¦ã€‚

è¿™ç§æœºåˆ¶ç¡®ä¿äº† React åº”ç”¨çš„é«˜å“åº”æ€§å’Œæ€§èƒ½ã€‚å¦‚æœä½ æœ‰ä»»ä½•ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥çš„è§£é‡Šï¼Œè¯·éšæ—¶æé—®ï¼ğŸ˜Š
