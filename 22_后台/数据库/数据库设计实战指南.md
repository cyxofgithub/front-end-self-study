# æ•°æ®åº“è®¾è®¡å®æˆ˜æŒ‡å—

> é€šè¿‡å®æˆ˜æ¡ˆä¾‹å­¦ä¹ æ•°æ®åº“è®¾è®¡ï¼Œæ¯ä¸ªæ¡ˆä¾‹éƒ½è¯¦ç»†è®²è§£è®¾è®¡æ€è·¯ã€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

## ğŸ“š ç›®å½•

1. [æ¡ˆä¾‹ 1ï¼šç”µå•†ç³»ç»Ÿ - è®¢å•å¿«ç…§è®¾è®¡](#æ¡ˆä¾‹-1ç”µå•†ç³»ç»Ÿ---è®¢å•å¿«ç…§è®¾è®¡)
2. [æ¡ˆä¾‹ 2ï¼šåšå®¢ç³»ç»Ÿ - è¯„è®ºæ ‘å½¢ç»“æ„è®¾è®¡](#æ¡ˆä¾‹-2åšå®¢ç³»ç»Ÿ---è¯„è®ºæ ‘å½¢ç»“æ„è®¾è®¡)
3. [æ¡ˆä¾‹ 3ï¼šç¤¾äº¤ç³»ç»Ÿ - å…³æ³¨å…³ç³»è®¾è®¡](#æ¡ˆä¾‹-3ç¤¾äº¤ç³»ç»Ÿ---å…³æ³¨å…³ç³»è®¾è®¡)
4. [æ¡ˆä¾‹ 4ï¼šåœ¨çº¿æ•™è‚²ç³»ç»Ÿ - å­¦ä¹ è¿›åº¦è®¾è®¡](#æ¡ˆä¾‹-4åœ¨çº¿æ•™è‚²ç³»ç»Ÿ---å­¦ä¹ è¿›åº¦è®¾è®¡)
5. [æ¡ˆä¾‹ 5ï¼šä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - çŠ¶æ€æµè½¬è®¾è®¡](#æ¡ˆä¾‹-5ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ---çŠ¶æ€æµè½¬è®¾è®¡)
6. [æ¡ˆä¾‹ 6ï¼šCMS ç³»ç»Ÿ - å¤šç§Ÿæˆ·è®¾è®¡](#æ¡ˆä¾‹-6cms-ç³»ç»Ÿ---å¤šç§Ÿæˆ·è®¾è®¡)
7. [æ¡ˆä¾‹ 7ï¼šæ—¥å¿—ç³»ç»Ÿ - é«˜å¹¶å‘å†™å…¥è®¾è®¡](#æ¡ˆä¾‹-7æ—¥å¿—ç³»ç»Ÿ---é«˜å¹¶å‘å†™å…¥è®¾è®¡)

---

## æ¡ˆä¾‹ 1ï¼šç”µå•†ç³»ç»Ÿ - è®¢å•å¿«ç…§è®¾è®¡

### éœ€æ±‚åœºæ™¯

ç”¨æˆ·ä¸‹å•åï¼Œå•†å“ä¿¡æ¯å¯èƒ½ä¼šå˜æ›´ï¼ˆä»·æ ¼è°ƒæ•´ã€åç§°ä¿®æ”¹ã€ä¸‹æ¶ç­‰ï¼‰ï¼Œä½†å†å²è®¢å•å¿…é¡»ä¿æŒä¸‹å•æ—¶çš„å•†å“ä¿¡æ¯ä¸å˜ã€‚

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
-- è®¢å•æ˜ç»†è¡¨
CREATE TABLE order_items (
    item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,  -- åªå­˜å•†å“ID
    quantity INT NOT NULL,
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

**é—®é¢˜**ï¼šå½“å•†å“ä»·æ ¼ä» 100 å…ƒæ”¹ä¸º 80 å…ƒåï¼ŒæŸ¥è¯¢å†å²è®¢å•æ—¶ï¼Œæ˜¾ç¤ºçš„ä»·æ ¼æ˜¯ 80 å…ƒï¼Œè€Œä¸æ˜¯ä¸‹å•æ—¶çš„ 100 å…ƒã€‚

### è®¾è®¡æ€è·¯

**æ ¸å¿ƒé—®é¢˜**ï¼šè®¢å•æ•°æ®éœ€è¦"å¿«ç…§"åŠŸèƒ½ï¼Œè®°å½•ä¸‹å•æ—¶çš„å•†å“ä¿¡æ¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨è®¢å•æ˜ç»†è¡¨ä¸­å†—ä½™å­˜å‚¨å•†å“ä¿¡æ¯å¿«ç…§ã€‚

### æœ€ç»ˆè®¾è®¡

```sql
-- è®¢å•æ˜ç»†è¡¨ï¼ˆå­˜å‚¨å¿«ç…§ï¼‰
CREATE TABLE order_items (
    item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,  -- ä¿ç•™å•†å“IDï¼Œä¾¿äºå…³è”æŸ¥è¯¢
    product_name VARCHAR(200) NOT NULL COMMENT 'å¿«ç…§ï¼šä¸‹å•æ—¶çš„å•†å“åç§°',
    product_price DECIMAL(10,2) NOT NULL COMMENT 'å¿«ç…§ï¼šä¸‹å•æ—¶çš„å•†å“ä»·æ ¼',
    product_image VARCHAR(255) COMMENT 'å¿«ç…§ï¼šä¸‹å•æ—¶çš„å•†å“å›¾ç‰‡',
    quantity INT NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL COMMENT 'å°è®¡ = product_price * quantity',
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id),
    INDEX idx_order_id (order_id),
    INDEX idx_product_id (product_id)
);
```

### è®¾è®¡è¦ç‚¹

1. **å†—ä½™å­˜å‚¨å¿«ç…§**ï¼šè™½ç„¶è¿åäº†èŒƒå¼åŒ–åŸåˆ™ï¼Œä½†è¿™æ˜¯ä¸šåŠ¡éœ€æ±‚ï¼Œå¿…é¡»å†—ä½™
2. **ä¿ç•™å•†å“ ID**ï¼šæ–¹ä¾¿åç»­å…³è”æŸ¥è¯¢å•†å“è¯¦æƒ…ã€åº“å­˜ç­‰
3. **å°è®¡å­—æ®µ**ï¼šé¢„è®¡ç®— `quantity * product_price`ï¼Œé¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½è®¡ç®—

### å®é™…åº”ç”¨

```sql
-- åˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦åŒæ—¶æ’å…¥å¿«ç…§æ•°æ®
INSERT INTO order_items (order_id, product_id, product_name, product_price, quantity, subtotal)
SELECT
    ? as order_id,
    product_id,
    product_name,  -- ä»å•†å“è¡¨è·å–
    price,         -- ä»å•†å“è¡¨è·å–
    ? as quantity,
    price * ? as subtotal
FROM products
WHERE product_id = ?;
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **è¯†åˆ«å¿«ç…§éœ€æ±‚**ï¼šèƒ½å¤Ÿè¯†åˆ«å“ªäº›ä¸šåŠ¡åœºæ™¯éœ€è¦æ•°æ®å¿«ç…§ï¼ˆè®¢å•ã€åˆåŒã€è´¦å•ç­‰ï¼‰
2. **åˆç†å†—ä½™è®¾è®¡**ï¼šç†è§£ä½•æ—¶åº”è¯¥è¿åèŒƒå¼åŒ–åŸåˆ™ï¼Œä¸ºäº†ä¸šåŠ¡éœ€æ±‚è¿›è¡Œåˆç†çš„å†—ä½™å­˜å‚¨
3. **å¿«ç…§å®ç°æŠ€å·§**ï¼šæŒæ¡åœ¨åˆ›å»ºè®¢å•æ—¶å¦‚ä½•ä»æºè¡¨è·å–æ•°æ®å¹¶å­˜å‚¨å¿«ç…§
4. **é¢„è®¡ç®—å­—æ®µ**ï¼šå­¦ä¼šä½¿ç”¨é¢„è®¡ç®—å­—æ®µï¼ˆå¦‚ `subtotal`ï¼‰é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œè®¡ç®—
5. **ä¸šåŠ¡ä¼˜å…ˆæ€ç»´**ï¼šç†è§£æ•°æ®åº“è®¾è®¡åº”è¯¥æœåŠ¡äºä¸šåŠ¡éœ€æ±‚ï¼Œè€Œä¸æ˜¯æ•™æ¡åœ°éµå¾ªç†è®º

**åº”ç”¨åœºæ™¯**ï¼šè®¢å•ç³»ç»Ÿã€åˆåŒç³»ç»Ÿã€è´¦å•ç³»ç»Ÿã€ä»»ä½•éœ€è¦è®°å½•å†å²çŠ¶æ€çš„ä¸šåŠ¡åœºæ™¯

---

## æ¡ˆä¾‹ 2ï¼šåšå®¢ç³»ç»Ÿ - è¯„è®ºæ ‘å½¢ç»“æ„è®¾è®¡

### éœ€æ±‚åœºæ™¯

ç”¨æˆ·å¯ä»¥å¯¹æ–‡ç« è¯„è®ºï¼Œä¹Ÿå¯ä»¥å›å¤è¯„è®ºï¼Œå½¢æˆå¤šçº§è¯„è®ºæ ‘ã€‚éœ€è¦æ”¯æŒï¼š

-   æ˜¾ç¤ºæ‰€æœ‰è¯„è®ºï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
-   æ˜¾ç¤ºæŸä¸ªè¯„è®ºçš„æ‰€æœ‰å›å¤
-   ç»Ÿè®¡è¯„è®ºæ€»æ•°

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
CREATE TABLE comments (
    comment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    article_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    parent_comment_id BIGINT,  -- çˆ¶è¯„è®ºIDï¼ŒNULLè¡¨ç¤ºé¡¶çº§è¯„è®º
    FOREIGN KEY (parent_comment_id) REFERENCES comments(comment_id) -- è‡ªå¼•ç”¨å¤–é”®ï¼ŒæŒ‡å‘åŒä¸€å¼ è¡¨çš„ä¸»é”®ï¼Œç”¨äºå®ç°çˆ¶å­å…³ç³»
);
```

**é—®é¢˜ 1**ï¼šæŸ¥è¯¢æŸä¸ªè¯„è®ºçš„æ‰€æœ‰å­è¯„è®ºéœ€è¦é€’å½’æŸ¥è¯¢ï¼Œæ€§èƒ½å·®
**é—®é¢˜ 2**ï¼šç»Ÿè®¡è¯„è®ºæ€»æ•°éœ€è¦éå†æ•´æ£µæ ‘

### è®¾è®¡æ€è·¯

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

1. **é‚»æ¥è¡¨ï¼ˆAdjacency Listï¼‰**ï¼šåªå­˜ `parent_id`

    - ä¼˜ç‚¹ï¼šç»“æ„ç®€å•
    - ç¼ºç‚¹ï¼šæŸ¥è¯¢å­æ ‘éœ€è¦é€’å½’ï¼Œæ€§èƒ½å·®

2. **è·¯å¾„æšä¸¾ï¼ˆPath Enumerationï¼‰**ï¼šå­˜å®Œæ•´è·¯å¾„ `1/2/3`

    - ä¼˜ç‚¹ï¼šæŸ¥è¯¢å­æ ‘å¿«
    - ç¼ºç‚¹ï¼šè·¯å¾„é•¿åº¦æœ‰é™ï¼Œç§»åŠ¨èŠ‚ç‚¹å›°éš¾

3. **é—­åŒ…è¡¨ï¼ˆClosure Tableï¼‰**ï¼šå•ç‹¬å­˜æ‰€æœ‰ç¥–å…ˆ-åä»£å…³ç³»
    - ä¼˜ç‚¹ï¼šæŸ¥è¯¢å¿«ï¼Œæ”¯æŒä»»æ„æ·±åº¦
    - ç¼ºç‚¹ï¼šå­˜å‚¨ç©ºé—´å¤§ï¼Œå†™å…¥å¤æ‚

**é€‰æ‹©**ï¼šå¯¹äºè¯„è®ºç³»ç»Ÿï¼Œå±‚çº§ä¸ä¼šå¤ªæ·±ï¼ˆé€šå¸¸ 2-3 å±‚ï¼‰ï¼Œä½¿ç”¨**é‚»æ¥è¡¨ + å†—ä½™å­—æ®µ**ä¼˜åŒ–ã€‚

### æœ€ç»ˆè®¾è®¡

```sql
CREATE TABLE comments (
    comment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    article_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    parent_id BIGINT DEFAULT 0 COMMENT '0è¡¨ç¤ºé¡¶çº§è¯„è®ºï¼Œå¦åˆ™ä¸ºçˆ¶è¯„è®ºID',
    content TEXT NOT NULL,
    level TINYINT DEFAULT 1 COMMENT 'å±‚çº§ï¼š1=é¡¶çº§ï¼Œ2=ä¸€çº§å›å¤ï¼Œ3=äºŒçº§å›å¤',
    path VARCHAR(500) COMMENT 'è·¯å¾„ï¼šå¦‚ 1/2/3ï¼Œä¾¿äºæŸ¥è¯¢å­æ ‘',
    like_count INT DEFAULT 0,
    reply_count INT DEFAULT 0 COMMENT 'å›å¤æ•°ï¼Œé¿å…é€’å½’ç»Ÿè®¡',
    status TINYINT DEFAULT 1 COMMENT '1:æ­£å¸¸ 2:å·²åˆ é™¤',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (article_id) REFERENCES articles(article_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    INDEX idx_article_id (article_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_path (path(255)) COMMENT 'å‰ç¼€ç´¢å¼•ï¼Œæ”¯æŒLIKEæŸ¥è¯¢'
);
```

### çœŸå®æ•°æ®

| comment_id | parent_id | level | path    | content    | reply_count | è¯´æ˜                               |
| ---------- | --------- | ----- | ------- | ---------- | ----------- | ---------------------------------- |
| 1          | 0         | 1     | `1`     | é¡¶çº§è¯„è®º 1 | 2           | é¡¶çº§è¯„è®ºï¼Œpath å°±æ˜¯è‡ªå·±çš„ ID       |
| 2          | 1         | 2     | `1/2`   | å›å¤è¯„è®º 1 | 1           | ä¸€çº§å›å¤ï¼Œpath æ˜¯çˆ¶ path + è‡ªå·± ID |
| 3          | 2         | 3     | `1/2/3` | å›å¤è¯„è®º 2 | 0           | äºŒçº§å›å¤ï¼Œå½¢æˆä¸‰çº§åµŒå¥—             |
| 4          | 1         | 2     | `1/4`   | å›å¤è¯„è®º 1 | 0           | è¯„è®º 1 çš„å¦ä¸€ä¸ªä¸€çº§å›å¤            |
| 5          | 0         | 1     | `5`     | é¡¶çº§è¯„è®º 2 | 1           | å¦ä¸€ä¸ªé¡¶çº§è¯„è®º                     |
| 6          | 5         | 2     | `5/6`   | å›å¤è¯„è®º 5 | 0           | è¯„è®º 5 çš„ä¸€çº§å›å¤                  |
| 7          | 0         | 1     | `7`     | é¡¶çº§è¯„è®º 3 | 0           | ç¬¬ä¸‰ä¸ªé¡¶çº§è¯„è®º                     |

**æ ‘å½¢ç»“æ„å¯è§†åŒ–**ï¼š

```
æ–‡ç« 1 (article_id = 1)
â”œâ”€â”€ è¯„è®º1 (comment_id=1, path=1) - "è¿™ç¯‡æ–‡ç« å†™å¾—çœŸå¥½ï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼"
â”‚   â”œâ”€â”€ å›å¤2 (comment_id=2, path=1/2) - "åŒæ„Ÿï¼ç‰¹åˆ«æ˜¯å…³äºæ•°æ®åº“è®¾è®¡çš„éƒ¨åˆ†"
â”‚   â”‚   â””â”€â”€ å›å¤3 (comment_id=3, path=1/2/3) - "æ˜¯çš„ï¼Œå¿«ç…§è®¾è®¡å¾ˆå®ç”¨"
â”‚   â””â”€â”€ å›å¤4 (comment_id=4, path=1/4) - "å¸Œæœ›èƒ½æœ‰æ›´å¤šå®æˆ˜æ¡ˆä¾‹"
â”œâ”€â”€ è¯„è®º5 (comment_id=5, path=5) - "æœ‰ä¸ªé—®é¢˜æƒ³è¯·æ•™ï¼šå¦‚ä½•å¤„ç†æ·±å±‚åµŒå¥—çš„è¯„è®ºï¼Ÿ"
â”‚   â””â”€â”€ å›å¤6 (comment_id=6, path=5/6) - "å¯ä»¥ä½¿ç”¨è·¯å¾„æšä¸¾ï¼Œpathå­—æ®µå¾ˆæ–¹ä¾¿"
â””â”€â”€ è¯„è®º7 (comment_id=7, path=7) - "æ„Ÿè°¢åˆ†äº«ï¼Œæ”¶è—äº†ï¼"
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```sql
-- æŸ¥è¯¢è¯„è®º1çš„æ‰€æœ‰å­è¯„è®ºï¼ˆåŒ…æ‹¬å›å¤2ã€3ã€4ï¼‰
SELECT * FROM comments
WHERE path LIKE '1/%' OR comment_id = 1
ORDER BY path;

-- ç»“æœï¼šcomment_id = 1, 2, 3, 4

-- æŸ¥è¯¢è¯„è®º1çš„ç›´æ¥å›å¤ï¼ˆä¸åŒ…æ‹¬äºŒçº§å›å¤ï¼‰
SELECT * FROM comments
WHERE parent_id = 1;

-- ç»“æœï¼šcomment_id = 2, 4

-- æŸ¥è¯¢æ‰€æœ‰é¡¶çº§è¯„è®º
SELECT * FROM comments
WHERE article_id = 1 AND parent_id = 0
ORDER BY created_at DESC;

-- ç»“æœï¼šcomment_id = 7, 5, 1ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
```

### è®¾è®¡è¦ç‚¹

1. **parent_id ä½¿ç”¨ 0 è€Œé NULL**ï¼šé¿å… NULL å€¼å¸¦æ¥çš„æŸ¥è¯¢å¤æ‚æ€§
2. **å†—ä½™ level å­—æ®µ**ï¼šå¿«é€Ÿåˆ¤æ–­è¯„è®ºå±‚çº§ï¼Œä¾¿äºå‰ç«¯å±•ç¤º
3. **å†—ä½™ path å­—æ®µ**ï¼šå¿«é€ŸæŸ¥è¯¢æŸä¸ªè¯„è®ºçš„æ‰€æœ‰å­è¯„è®º
4. **å†—ä½™ reply_count**ï¼šé¿å…é€’å½’ç»Ÿè®¡å›å¤æ•°

### å®é™…åº”ç”¨

```sql
-- æŸ¥è¯¢æ–‡ç« çš„æ‰€æœ‰é¡¶çº§è¯„è®º
SELECT * FROM comments
WHERE article_id = ? AND parent_id = 0
ORDER BY created_at DESC;

-- æŸ¥è¯¢æŸä¸ªè¯„è®ºçš„æ‰€æœ‰å›å¤ï¼ˆåˆ©ç”¨pathï¼‰
SELECT * FROM comments
WHERE path LIKE CONCAT((SELECT path FROM comments WHERE comment_id = ?), '/%')
ORDER BY created_at ASC;

-- æ·»åŠ å›å¤æ—¶ï¼Œæ›´æ–°pathå’Œlevel
INSERT INTO comments (article_id, user_id, parent_id, content, level, path)
SELECT
    ? as article_id,
    ? as user_id,
    ? as parent_id,
    ? as content,
    level + 1,
    CONCAT(path, '/', LAST_INSERT_ID())
FROM comments
WHERE comment_id = ?;
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **æ ‘å½¢ç»“æ„è®¾è®¡**ï¼šç†è§£é‚»æ¥è¡¨ã€è·¯å¾„æšä¸¾ã€é—­åŒ…è¡¨ä¸‰ç§æ ‘å½¢ç»“æ„è®¾è®¡æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹
2. **æ–¹æ¡ˆé€‰æ‹©èƒ½åŠ›**ï¼šèƒ½å¤Ÿæ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼ˆå±‚çº§æ·±åº¦ã€æŸ¥è¯¢é¢‘ç‡ï¼‰é€‰æ‹©æœ€åˆé€‚çš„æ ‘å½¢ç»“æ„è®¾è®¡æ–¹æ¡ˆ
3. **æ€§èƒ½ä¼˜åŒ–æŠ€å·§**ï¼šå­¦ä¼šä½¿ç”¨å†—ä½™å­—æ®µï¼ˆ`level`ã€`path`ã€`reply_count`ï¼‰ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
4. **è·¯å¾„æŸ¥è¯¢ä¼˜åŒ–**ï¼šæŒæ¡ä½¿ç”¨ `path LIKE` æŸ¥è¯¢å­æ ‘ï¼Œé¿å…é€’å½’æŸ¥è¯¢
5. **NULL vs 0 çš„é€‰æ‹©**ï¼šç†è§£ä¸ºä»€ä¹ˆåœ¨æŸäº›åœºæ™¯ä¸‹ä½¿ç”¨ 0 è€Œé NULL æ›´åˆé€‚

**åº”ç”¨åœºæ™¯**ï¼šè¯„è®ºç³»ç»Ÿã€ç»„ç»‡æ¶æ„ã€åˆ†ç±»æ ‘ã€èœå•æ ‘ã€æƒé™æ ‘ã€ä»»ä½•æ ‘å½¢ç»“æ„æ•°æ®

---

## æ¡ˆä¾‹ 3ï¼šç¤¾äº¤ç³»ç»Ÿ - å…³æ³¨å…³ç³»è®¾è®¡

### éœ€æ±‚åœºæ™¯

ç”¨æˆ· A å…³æ³¨ç”¨æˆ· Bï¼Œéœ€è¦æ”¯æŒï¼š

-   æŸ¥è¯¢ A å…³æ³¨äº†è°ï¼ˆå…³æ³¨åˆ—è¡¨ï¼‰
-   æŸ¥è¯¢è°å…³æ³¨äº† Aï¼ˆç²‰ä¸åˆ—è¡¨ï¼‰
-   åˆ¤æ–­ A æ˜¯å¦å…³æ³¨äº† B
-   æŸ¥è¯¢ A å’Œ B æ˜¯å¦äº’ç›¸å…³æ³¨

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
CREATE TABLE follows (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    follow_user_id BIGINT NOT NULL COMMENT 'å…³æ³¨çš„ç”¨æˆ·ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (user_id, follow_user_id)
);
```

**é—®é¢˜**ï¼šå­—æ®µå‘½åä¸æ¸…æ™°ï¼Œ`user_id` å’Œ `follow_user_id` å®¹æ˜“æ··æ·†ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦æ€è€ƒå“ªä¸ªæ˜¯å…³æ³¨è€…ã€‚

### è®¾è®¡æ€è·¯

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•æ¸…æ™°åœ°è¡¨ç¤º"è°å…³æ³¨äº†è°"ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨è¯­ä¹‰æ˜ç¡®çš„å­—æ®µåï¼ŒåŒºåˆ†å…³æ³¨è€…å’Œè¢«å…³æ³¨è€…ã€‚

### æœ€ç»ˆè®¾è®¡

```sql
CREATE TABLE follows (
    follow_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    follower_id BIGINT NOT NULL COMMENT 'å…³æ³¨è€…IDï¼ˆç²‰ä¸ï¼‰',
    following_id BIGINT NOT NULL COMMENT 'è¢«å…³æ³¨è€…IDï¼ˆåšä¸»ï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (follower_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (following_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE KEY uk_follower_following (follower_id, following_id),
    INDEX idx_follower_id (follower_id) COMMENT 'æŸ¥è¯¢å…³æ³¨åˆ—è¡¨',
    INDEX idx_following_id (following_id) COMMENT 'æŸ¥è¯¢ç²‰ä¸åˆ—è¡¨'
);
```

### è®¾è®¡è¦ç‚¹

1. **è¯­ä¹‰æ˜ç¡®çš„å­—æ®µå**ï¼š`follower_id`ï¼ˆç²‰ä¸ï¼‰å…³æ³¨ `following_id`ï¼ˆåšä¸»ï¼‰
2. **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤å…³æ³¨
3. **åŒå‘ç´¢å¼•**ï¼š`idx_follower_id` ç”¨äºæŸ¥è¯¢å…³æ³¨åˆ—è¡¨ï¼Œ`idx_following_id` ç”¨äºæŸ¥è¯¢ç²‰ä¸åˆ—è¡¨

### å®é™…åº”ç”¨

```sql
-- æŸ¥è¯¢ç”¨æˆ·Açš„å…³æ³¨åˆ—è¡¨ï¼ˆAå…³æ³¨äº†è°ï¼‰
SELECT u.* FROM users u
JOIN follows f ON u.user_id = f.following_id
WHERE f.follower_id = ?;

-- æŸ¥è¯¢ç”¨æˆ·Açš„ç²‰ä¸åˆ—è¡¨ï¼ˆè°å…³æ³¨äº†Aï¼‰
SELECT u.* FROM users u
JOIN follows f ON u.user_id = f.follower_id
WHERE f.following_id = ?;

-- åˆ¤æ–­Aæ˜¯å¦å…³æ³¨äº†B
SELECT COUNT(*) FROM follows
WHERE follower_id = ? AND following_id = ?;

-- æŸ¥è¯¢äº’ç›¸å…³æ³¨ï¼ˆéœ€è¦JOINä¸¤æ¬¡ï¼‰
SELECT f1.follower_id, f1.following_id
FROM follows f1
JOIN follows f2 ON f1.follower_id = f2.following_id
    AND f1.following_id = f2.follower_id;
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **å…³ç³»è¡¨è®¾è®¡**ï¼šæŒæ¡å¦‚ä½•è®¾è®¡æ¸…æ™°çš„å…³ç³»è¡¨ï¼Œä½¿ç”¨è¯­ä¹‰æ˜ç¡®çš„å­—æ®µå
2. **åŒå‘æŸ¥è¯¢ä¼˜åŒ–**ï¼šç†è§£å¦‚ä½•ä¸ºåŒå‘æŸ¥è¯¢ï¼ˆå…³æ³¨åˆ—è¡¨/ç²‰ä¸åˆ—è¡¨ï¼‰è®¾è®¡åˆé€‚çš„ç´¢å¼•
3. **å”¯ä¸€çº¦æŸè®¾è®¡**ï¼šå­¦ä¼šä½¿ç”¨å¤åˆå”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤å…³ç³»
4. **å¤æ‚å…³ç³»æŸ¥è¯¢**ï¼šæŒæ¡å¦‚ä½•æŸ¥è¯¢äº’ç›¸å…³æ³¨ç­‰å¤æ‚å…³ç³»
5. **å­—æ®µå‘½åè§„èŒƒ**ï¼šç†è§£å¥½çš„å­—æ®µå‘½åï¼ˆ`follower_id`/`following_id`ï¼‰å¦‚ä½•æé«˜ä»£ç å¯è¯»æ€§

**åº”ç”¨åœºæ™¯**ï¼šç¤¾äº¤ç³»ç»Ÿã€å…³æ³¨/ç²‰ä¸å…³ç³»ã€å¥½å‹å…³ç³»ã€ç‚¹èµå…³ç³»ã€æ”¶è—å…³ç³»ã€ä»»ä½•åŒå‘å…³ç³»åœºæ™¯

---

## æ¡ˆä¾‹ 4ï¼šåœ¨çº¿æ•™è‚²ç³»ç»Ÿ - å­¦ä¹ è¿›åº¦è®¾è®¡

### éœ€æ±‚åœºæ™¯

å­¦ç”Ÿè´­ä¹°è¯¾ç¨‹åï¼Œéœ€è¦è®°å½•ï¼š

-   æ¯ä¸ªç« èŠ‚çš„å­¦ä¹ è¿›åº¦ï¼ˆå·²å­¦ä¹ /æœªå­¦ä¹ ï¼‰
-   æ¯ä¸ªè§†é¢‘çš„è§‚çœ‹æ—¶é•¿
-   è¯¾ç¨‹çš„æ•´ä½“å­¦ä¹ è¿›åº¦ç™¾åˆ†æ¯”
-   æœ€åå­¦ä¹ ä½ç½®ï¼ˆæ–­ç‚¹ç»­æ’­ï¼‰

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
-- åªè®°å½•è¯¾ç¨‹å­¦ä¹ çŠ¶æ€
CREATE TABLE course_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    progress_percent INT DEFAULT 0 COMMENT 'å­¦ä¹ è¿›åº¦ç™¾åˆ†æ¯”',
    last_study_time TIMESTAMP,
    UNIQUE KEY (user_id, course_id)
);
```

**é—®é¢˜**ï¼š

1. æ— æ³•çŸ¥é“å…·ä½“å“ªä¸ªç« èŠ‚å·²å­¦ä¹ 
2. æ— æ³•è®°å½•è§†é¢‘è§‚çœ‹æ—¶é•¿
3. è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—ä¸å‡†ç¡®

### è®¾è®¡æ€è·¯

**æ ¸å¿ƒé—®é¢˜**ï¼šéœ€è¦åŒæ—¶è®°å½•æ•´ä½“è¿›åº¦å’Œæ˜ç»†è¿›åº¦ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡‡ç”¨"æ±‡æ€»è¡¨ + æ˜ç»†è¡¨"çš„è®¾è®¡æ¨¡å¼ã€‚

### æœ€ç»ˆè®¾è®¡

```sql
-- 1. è¯¾ç¨‹å­¦ä¹ è¿›åº¦æ±‡æ€»è¡¨
CREATE TABLE course_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    total_chapters INT DEFAULT 0 COMMENT 'æ€»ç« èŠ‚æ•°',
    completed_chapters INT DEFAULT 0 COMMENT 'å·²å®Œæˆç« èŠ‚æ•°',
    progress_percent DECIMAL(5,2) DEFAULT 0 COMMENT 'å­¦ä¹ è¿›åº¦ç™¾åˆ†æ¯”',
    last_chapter_id BIGINT COMMENT 'æœ€åå­¦ä¹ çš„ç« èŠ‚ID',
    last_study_time TIMESTAMP COMMENT 'æœ€åå­¦ä¹ æ—¶é—´',
    completed_at TIMESTAMP NULL COMMENT 'å®Œæˆæ—¶é—´',
    UNIQUE KEY uk_user_course (user_id, course_id),
    INDEX idx_user_id (user_id),
    INDEX idx_course_id (course_id)
);

-- 2. ç« èŠ‚å­¦ä¹ è¿›åº¦æ˜ç»†è¡¨
CREATE TABLE chapter_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    chapter_id BIGINT NOT NULL,
    status TINYINT DEFAULT 0 COMMENT '0:æœªå­¦ä¹  1:å­¦ä¹ ä¸­ 2:å·²å®Œæˆ',
    study_duration INT DEFAULT 0 COMMENT 'å­¦ä¹ æ—¶é•¿ï¼ˆç§’ï¼‰',
    last_position INT DEFAULT 0 COMMENT 'æœ€åè§‚çœ‹ä½ç½®ï¼ˆç§’ï¼‰',
    completed_at TIMESTAMP NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES courses(course_id),
    FOREIGN KEY (chapter_id) REFERENCES chapters(chapter_id),
    UNIQUE KEY uk_user_chapter (user_id, course_id, chapter_id),
    INDEX idx_user_course (user_id, course_id),
    INDEX idx_chapter_id (chapter_id)
);
```

### è®¾è®¡è¦ç‚¹

1. **æ±‡æ€»è¡¨ + æ˜ç»†è¡¨**ï¼šæ±‡æ€»è¡¨å¿«é€ŸæŸ¥è¯¢æ•´ä½“è¿›åº¦ï¼Œæ˜ç»†è¡¨è®°å½•è¯¦ç»†ä¿¡æ¯
2. **å†—ä½™å­—æ®µ**ï¼š`course_id` åœ¨æ˜ç»†è¡¨ä¸­å†—ä½™ï¼Œé¿å… JOIN æŸ¥è¯¢
3. **è¿›åº¦è®¡ç®—**ï¼š`progress_percent = (completed_chapters / total_chapters) * 100`
4. **æ–­ç‚¹ç»­æ’­**ï¼š`last_position` è®°å½•è§†é¢‘è§‚çœ‹ä½ç½®

### å®é™…åº”ç”¨

```sql
-- æ›´æ–°ç« èŠ‚å­¦ä¹ è¿›åº¦
UPDATE chapter_progress
SET status = 2, completed_at = NOW(), study_duration = study_duration + ?
WHERE user_id = ? AND chapter_id = ?;

-- åŒæ­¥æ›´æ–°è¯¾ç¨‹æ•´ä½“è¿›åº¦
UPDATE course_progress cp
SET
    completed_chapters = (
        SELECT COUNT(*) FROM chapter_progress
        WHERE user_id = cp.user_id
        AND course_id = cp.course_id
        AND status = 2
    ),
    progress_percent = ROUND(
        (completed_chapters / total_chapters) * 100,
        2
    ),
    last_chapter_id = ?,
    last_study_time = NOW()
WHERE user_id = ? AND course_id = ?;
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **æ±‡æ€»è¡¨+æ˜ç»†è¡¨æ¨¡å¼**ï¼šç†è§£ä½•æ—¶éœ€è¦åŒæ—¶è®¾è®¡æ±‡æ€»è¡¨å’Œæ˜ç»†è¡¨ï¼Œå…¼é¡¾æŸ¥è¯¢æ€§èƒ½å’Œè¯¦ç»†ä¿¡æ¯
2. **è¿›åº¦è®¡ç®—è®¾è®¡**ï¼šæŒæ¡å¦‚ä½•è®¾è®¡å­¦ä¹ è¿›åº¦ã€å®Œæˆåº¦ç­‰ç™¾åˆ†æ¯”è®¡ç®—å­—æ®µ
3. **å†—ä½™å­—æ®µä½¿ç”¨**ï¼šå­¦ä¼šåœ¨æ˜ç»†è¡¨ä¸­å†—ä½™å­˜å‚¨ `course_id` ç­‰å­—æ®µï¼Œé¿å…é¢‘ç¹ JOIN
4. **æ–­ç‚¹ç»­æ’­è®¾è®¡**ï¼šç†è§£å¦‚ä½•è®¾è®¡ `last_position` ç­‰å­—æ®µæ”¯æŒæ–­ç‚¹ç»­æ’­åŠŸèƒ½
5. **æ•°æ®åŒæ­¥ç­–ç•¥**ï¼šæŒæ¡å¦‚ä½•åŒæ­¥æ›´æ–°æ±‡æ€»è¡¨å’Œæ˜ç»†è¡¨çš„æ•°æ®

**åº”ç”¨åœºæ™¯**ï¼šåœ¨çº¿æ•™è‚²ã€å­¦ä¹ è¿›åº¦ã€ä»»åŠ¡å®Œæˆåº¦ã€é¡¹ç›®è¿›åº¦ã€ä»»ä½•éœ€è¦è®°å½•æ˜ç»†å’Œæ±‡æ€»çš„åœºæ™¯

---

## æ¡ˆä¾‹ 5ï¼šä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - çŠ¶æ€æµè½¬è®¾è®¡

### éœ€æ±‚åœºæ™¯

ä»»åŠ¡æœ‰å¤šç§çŠ¶æ€ï¼šå¾…å¤„ç†ã€è¿›è¡Œä¸­ã€å·²å®Œæˆã€å·²å–æ¶ˆã€‚éœ€è¦ï¼š

-   è®°å½•çŠ¶æ€å˜æ›´å†å²
-   æ”¯æŒçŠ¶æ€æµè½¬è§„åˆ™ï¼ˆå¦‚ï¼šå·²å®Œæˆä¸èƒ½å˜å›å¾…å¤„ç†ï¼‰
-   æŸ¥è¯¢ä»»åŠ¡å½“å‰çŠ¶æ€å’Œå†å²çŠ¶æ€

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
CREATE TABLE tasks (
    task_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' COMMENT 'pending/in_progress/completed/cancelled',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**é—®é¢˜**ï¼š

1. æ— æ³•æŸ¥è¯¢çŠ¶æ€å˜æ›´å†å²
2. æ— æ³•çŸ¥é“çŠ¶æ€å˜æ›´æ—¶é—´å’Œæ“ä½œäºº
3. çŠ¶æ€å€¼ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå®¹æ˜“æ‹¼å†™é”™è¯¯

### è®¾è®¡æ€è·¯

**æ ¸å¿ƒé—®é¢˜**ï¼šéœ€è¦åŒæ—¶è®°å½•å½“å‰çŠ¶æ€å’Œå†å²çŠ¶æ€ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ä»»åŠ¡è¡¨è®°å½•å½“å‰çŠ¶æ€
2. çŠ¶æ€å˜æ›´å†å²è¡¨è®°å½•æ‰€æœ‰å˜æ›´è®°å½•
3. ä½¿ç”¨çŠ¶æ€ç è€Œéå­—ç¬¦ä¸²

### æœ€ç»ˆè®¾è®¡

```sql
-- 1. ä»»åŠ¡è¡¨ï¼ˆè®°å½•å½“å‰çŠ¶æ€ï¼‰
CREATE TABLE tasks (
    task_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    assignee_id BIGINT COMMENT 'è´Ÿè´£äººID',
    status TINYINT DEFAULT 1 COMMENT '1:å¾…å¤„ç† 2:è¿›è¡Œä¸­ 3:å·²å®Œæˆ 4:å·²å–æ¶ˆ',
    priority TINYINT DEFAULT 2 COMMENT '1:ä½ 2:ä¸­ 3:é«˜',
    due_date DATE COMMENT 'æˆªæ­¢æ—¥æœŸ',
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_assignee_id (assignee_id),
    INDEX idx_status (status),
    INDEX idx_due_date (due_date)
);

-- 2. ä»»åŠ¡çŠ¶æ€å˜æ›´å†å²è¡¨
CREATE TABLE task_status_history (
    history_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL,
    from_status TINYINT COMMENT 'åŸçŠ¶æ€ï¼ŒNULLè¡¨ç¤ºåˆ›å»º',
    to_status TINYINT NOT NULL COMMENT 'æ–°çŠ¶æ€',
    operator_id BIGINT NOT NULL COMMENT 'æ“ä½œäººID',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(task_id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_created_at (created_at)
);
```

### è®¾è®¡è¦ç‚¹

1. **çŠ¶æ€ç è®¾è®¡**ï¼šä½¿ç”¨ `TINYINT` è€Œé `VARCHAR`ï¼ŒèŠ‚çœç©ºé—´ä¸”é¿å…æ‹¼å†™é”™è¯¯
2. **å†å²è¡¨è®¾è®¡**ï¼šè®°å½• `from_status` å’Œ `to_status`ï¼Œå½¢æˆå®Œæ•´çš„çŠ¶æ€æµè½¬é“¾
3. **æ“ä½œäººè®°å½•**ï¼šè®°å½•æ¯æ¬¡çŠ¶æ€å˜æ›´çš„æ“ä½œäººï¼Œä¾¿äºè¿½æº¯

### å®é™…åº”ç”¨

```sql
-- æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆéœ€è¦åŒæ—¶æ›´æ–°ä»»åŠ¡è¡¨å’Œå†å²è¡¨ï¼‰
BEGIN;

-- æ›´æ–°ä»»åŠ¡çŠ¶æ€
UPDATE tasks
SET status = ?, updated_at = NOW()
WHERE task_id = ?;

-- è®°å½•çŠ¶æ€å˜æ›´å†å²
INSERT INTO task_status_history (task_id, from_status, to_status, operator_id, remark)
SELECT status, ?, ?, ?
FROM tasks
WHERE task_id = ?;

COMMIT;

-- æŸ¥è¯¢ä»»åŠ¡çš„çŠ¶æ€æµè½¬å†å²
-- ä½¿ç”¨å¤šè¡¨ JOIN æŸ¥è¯¢çŠ¶æ€å˜æ›´å†å²ï¼Œå¹¶å…³è”å‡ºæ“ä½œäººå§“åå’ŒçŠ¶æ€åç§°
-- LEFT JOIN ç¡®ä¿å³ä½¿å…³è”æ•°æ®ä¸å­˜åœ¨ä¹Ÿèƒ½è¿”å›å†å²è®°å½•
SELECT
    tsh.*,                                    -- å†å²è¡¨æ‰€æœ‰å­—æ®µ
    u1.username as operator_name,             -- æ“ä½œäººå§“åï¼ˆä» users è¡¨è·å–ï¼‰
    s1.status_name as from_status_name,       -- åŸçŠ¶æ€åç§°ï¼ˆä»çŠ¶æ€å­—å…¸è·å–ï¼‰
    s2.status_name as to_status_name          -- æ–°çŠ¶æ€åç§°ï¼ˆä»çŠ¶æ€å­—å…¸è·å–ï¼‰
FROM task_status_history tsh
LEFT JOIN users u1 ON tsh.operator_id = u1.user_id         -- å…³è”ç”¨æˆ·è¡¨ï¼Œè·å–æ“ä½œäººä¿¡æ¯
LEFT JOIN status_dict s1 ON tsh.from_status = s1.status_code  -- å…³è”çŠ¶æ€å­—å…¸ï¼Œè·å–åŸçŠ¶æ€åç§°
LEFT JOIN status_dict s2 ON tsh.to_status = s2.status_code    -- å…³è”çŠ¶æ€å­—å…¸ï¼Œè·å–æ–°çŠ¶æ€åç§°
WHERE tsh.task_id = ?                         -- è¿‡æ»¤æŒ‡å®šä»»åŠ¡çš„å†å²è®°å½•
ORDER BY tsh.created_at ASC;                  -- æŒ‰æ—¶é—´å‡åºï¼Œå±•ç¤ºå®Œæ•´çš„çŠ¶æ€æµè½¬è¿‡ç¨‹
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **çŠ¶æ€æµè½¬è®¾è®¡**ï¼šç†è§£å¦‚ä½•è®¾è®¡çŠ¶æ€å­—æ®µï¼Œä½¿ç”¨çŠ¶æ€ç è€Œéå­—ç¬¦ä¸²
2. **å†å²è®°å½•è®¾è®¡**ï¼šæŒæ¡å¦‚ä½•è®¾è®¡å†å²è¡¨è®°å½•å®Œæ•´çš„çŠ¶æ€å˜æ›´é“¾
3. **å®¡è®¡è¿½æº¯èƒ½åŠ›**ï¼šå­¦ä¼šè®°å½•æ“ä½œäººã€æ“ä½œæ—¶é—´ç­‰ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜è¿½æº¯
4. **äº‹åŠ¡å¤„ç†**ï¼šç†è§£æ›´æ–°çŠ¶æ€æ—¶éœ€è¦åŒæ—¶æ›´æ–°ä¸»è¡¨å’Œå†å²è¡¨ï¼Œä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
5. **çŠ¶æ€ç è®¾è®¡**ï¼šæŒæ¡ä½¿ç”¨ `TINYINT` å­˜å‚¨çŠ¶æ€ç ï¼ŒèŠ‚çœç©ºé—´ä¸”é¿å…æ‹¼å†™é”™è¯¯

**åº”ç”¨åœºæ™¯**ï¼šä»»åŠ¡ç®¡ç†ã€å·¥å•ç³»ç»Ÿã€å®¡æ‰¹æµç¨‹ã€è®¢å•çŠ¶æ€ã€ä»»ä½•æœ‰çŠ¶æ€æµè½¬çš„ä¸šåŠ¡åœºæ™¯

---

## æ¡ˆä¾‹ 6ï¼šCMS ç³»ç»Ÿ - å¤šç§Ÿæˆ·è®¾è®¡

### éœ€æ±‚åœºæ™¯

SaaS å†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œå¤šä¸ªå®¢æˆ·ï¼ˆç§Ÿæˆ·ï¼‰ä½¿ç”¨åŒä¸€å¥—ç³»ç»Ÿï¼Œä½†æ•°æ®éœ€è¦å®Œå…¨éš”ç¦»ã€‚éœ€è¦ï¼š

-   æ¯ä¸ªç§Ÿæˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®
-   æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®
-   æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æƒé™æ§åˆ¶

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
-- æ²¡æœ‰ç§Ÿæˆ·éš”ç¦»
CREATE TABLE articles (
    article_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**é—®é¢˜**ï¼šæ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®æ··åœ¨ä¸€èµ·ï¼Œæ— æ³•éš”ç¦»ã€‚

### è®¾è®¡æ€è·¯

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

1. **å…±äº«æ•°æ®åº“ï¼Œå…±äº«è¡¨**ï¼šæ¯ä¸ªè¡¨æ·»åŠ  `tenant_id`

    - ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæˆæœ¬ä½
    - ç¼ºç‚¹ï¼šæ•°æ®é‡å¤§æ—¶æ€§èƒ½å·®ï¼Œéš¾ä»¥æ‰©å±•

2. **å…±äº«æ•°æ®åº“ï¼Œç‹¬ç«‹è¡¨**ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹çš„è¡¨ `articles_tenant_1`

    - ä¼˜ç‚¹ï¼šæ•°æ®éš”ç¦»å¥½
    - ç¼ºç‚¹ï¼šè¡¨æ•°é‡å¤šï¼Œéš¾ä»¥ç®¡ç†

3. **ç‹¬ç«‹æ•°æ®åº“**ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“
    - ä¼˜ç‚¹ï¼šå®Œå…¨éš”ç¦»ï¼Œæ€§èƒ½å¥½
    - ç¼ºç‚¹ï¼šæˆæœ¬é«˜ï¼Œéš¾ä»¥ç»´æŠ¤

**é€‰æ‹©**ï¼šå¯¹äºä¸­å°å‹ SaaSï¼Œä½¿ç”¨**æ–¹æ¡ˆ 1**ï¼Œæ¯ä¸ªè¡¨æ·»åŠ  `tenant_id`ã€‚

### æœ€ç»ˆè®¾è®¡

```sql
-- 1. ç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    tenant_id INT PRIMARY KEY AUTO_INCREMENT,
    tenant_name VARCHAR(100) NOT NULL,
    domain VARCHAR(100) UNIQUE COMMENT 'ç§Ÿæˆ·åŸŸå',
    status TINYINT DEFAULT 1 COMMENT '1:æ­£å¸¸ 2:ç¦ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. æ–‡ç« è¡¨ï¼ˆæ·»åŠ tenant_idï¼‰
CREATE TABLE articles (
    article_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id INT NOT NULL COMMENT 'ç§Ÿæˆ·ID',
    title VARCHAR(200) NOT NULL,
    content TEXT,
    status TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tenant_id) REFERENCES tenants(tenant_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_tenant_status (tenant_id, status)
) COMMENT 'æ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼Œé€šè¿‡tenant_idéš”ç¦»';

-- 3. ç”¨æˆ·è¡¨ï¼ˆæ·»åŠ tenant_idï¼‰
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id INT NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tenant_id) REFERENCES tenants(tenant_id),
    UNIQUE KEY uk_tenant_username (tenant_id, username),
    UNIQUE KEY uk_tenant_email (tenant_id, email),
    INDEX idx_tenant_id (tenant_id)
);
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†ç§Ÿæˆ·è¡¨å’Œç”¨æˆ·è¡¨ï¼Ÿ**

-   ç§Ÿæˆ·ï¼ˆTenantï¼‰ï¼šç»„ç»‡/å…¬å¸/å®¢æˆ·ï¼Œæ˜¯ SaaS çš„è´­ä¹°æ–¹
-   ç”¨æˆ·ï¼ˆUserï¼‰ï¼šç§Ÿæˆ·å†…éƒ¨çš„æˆå‘˜ï¼Œæ˜¯ç³»ç»Ÿçš„ä½¿ç”¨è€…
    å…³ç³»ï¼šä¸€ä¸ªç§Ÿæˆ·å¯ä»¥æœ‰å¤šä¸ªç”¨æˆ·ï¼ˆ1 å¯¹å¤šï¼‰

### è®¾è®¡è¦ç‚¹

1. **æ‰€æœ‰è¡¨æ·»åŠ  tenant_id**ï¼šç¡®ä¿æ•°æ®éš”ç¦»
2. **å”¯ä¸€çº¦æŸåŒ…å« tenant_id**ï¼š`UNIQUE KEY uk_tenant_username (tenant_id, username)`ï¼ŒåŒä¸€ç§Ÿæˆ·å†…ç”¨æˆ·åå¿…é¡»å”¯ä¸€ï¼Œä½†ä¸åŒç§Ÿæˆ·ä¹‹é—´å¯ä»¥æœ‰ç›¸åŒçš„ç”¨æˆ·å
3. **ç´¢å¼•è®¾è®¡**ï¼šæ‰€æœ‰æŸ¥è¯¢æ¡ä»¶éƒ½åŒ…å« `tenant_id`ï¼Œæ‰€ä»¥ç´¢å¼•ä»¥ `tenant_id` å¼€å¤´

### å®é™…åº”ç”¨

```sql
-- æŸ¥è¯¢ç§Ÿæˆ·çš„æ–‡ç« ï¼ˆå¿…é¡»å¸¦ä¸Štenant_idï¼‰
SELECT * FROM articles
WHERE tenant_id = ? AND status = 1
ORDER BY created_at DESC;

-- åˆ›å»ºæ–‡ç« ï¼ˆè‡ªåŠ¨æ³¨å…¥tenant_idï¼‰
INSERT INTO articles (tenant_id, title, content)
VALUES (?, ?, ?);

-- åœ¨åº”ç”¨å±‚å°è£…ï¼šæ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨æ·»åŠ tenant_idè¿‡æ»¤
-- ä¾‹å¦‚ï¼šArticle::where('tenant_id', $currentTenantId)->get();
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»**ï¼šç†è§£å¦‚ä½•é€šè¿‡ `tenant_id` å®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
2. **å”¯ä¸€çº¦æŸè®¾è®¡**ï¼šæŒæ¡å¦‚ä½•åœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸‹è®¾è®¡å”¯ä¸€çº¦æŸï¼ˆåŒ…å« `tenant_id`ï¼‰
3. **ç´¢å¼•è®¾è®¡ç­–ç•¥**ï¼šç†è§£å¤šç§Ÿæˆ·åœºæ™¯ä¸‹çš„ç´¢å¼•è®¾è®¡ï¼Œæ‰€æœ‰ç´¢å¼•éƒ½ä»¥ `tenant_id` å¼€å¤´
4. **æŸ¥è¯¢å®‰å…¨**ï¼šå­¦ä¼šåœ¨åº”ç”¨å±‚ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« `tenant_id` è¿‡æ»¤ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
5. **æ–¹æ¡ˆé€‰æ‹©èƒ½åŠ›**ï¼šç†è§£å…±äº«è¡¨ã€ç‹¬ç«‹è¡¨ã€ç‹¬ç«‹æ•°æ®åº“ä¸‰ç§æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯

**åº”ç”¨åœºæ™¯**ï¼šSaaS ç³»ç»Ÿã€å¤šç§Ÿæˆ·ç³»ç»Ÿã€ä¼ä¸šçº§åº”ç”¨ã€ä»»ä½•éœ€è¦æ•°æ®éš”ç¦»çš„åœºæ™¯

---

## æ¡ˆä¾‹ 7ï¼šæ—¥å¿—ç³»ç»Ÿ - é«˜å¹¶å‘å†™å…¥è®¾è®¡

### éœ€æ±‚åœºæ™¯

ç³»ç»Ÿéœ€è¦è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—ï¼Œç‰¹ç‚¹ï¼š

-   å†™å…¥é¢‘ç‡é«˜ï¼ˆæ¯ç§’æ•°åƒæ¡ï¼‰
-   æŸ¥è¯¢é¢‘ç‡ä½ï¼ˆä¸»è¦æ˜¯ç»Ÿè®¡åˆ†æï¼‰
-   æ•°æ®é‡å¤§ï¼ˆæ¯å¤©ç™¾ä¸‡çº§ï¼‰
-   éœ€è¦æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢

### ç¬¬ä¸€æ¬¡è®¾è®¡ï¼ˆé”™è¯¯ï¼‰

```sql
CREATE TABLE operation_logs (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    operation_type VARCHAR(50),
    content TEXT,
    ip_address VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);
```

**é—®é¢˜**ï¼š

1. é«˜å¹¶å‘å†™å…¥æ—¶ï¼Œä¸»é”®è‡ªå¢é”ç«äº‰æ¿€çƒˆ
2. å•è¡¨æ•°æ®é‡è¿‡å¤§ï¼ŒæŸ¥è¯¢æ…¢
3. ç´¢å¼•è¿‡å¤šå½±å“å†™å…¥æ€§èƒ½

### è®¾è®¡æ€è·¯

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•ä¼˜åŒ–é«˜å¹¶å‘å†™å…¥æ€§èƒ½ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **åˆ†è¡¨**ï¼šæŒ‰æ—¶é—´åˆ†è¡¨ï¼ˆæŒ‰æœˆæˆ–æŒ‰å¤©ï¼‰
2. **å‡å°‘ç´¢å¼•**ï¼šåªä¿ç•™å¿…è¦çš„ç´¢å¼•
3. **å¼‚æ­¥å†™å…¥**ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²å†™å…¥

### æœ€ç»ˆè®¾è®¡

```sql
-- æŒ‰æœˆåˆ†è¡¨ï¼šoperation_logs_202401, operation_logs_202402
CREATE TABLE operation_logs_202401 (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    operation_type VARCHAR(50),
    table_name VARCHAR(50) COMMENT 'æ“ä½œçš„è¡¨å',
    record_id BIGINT COMMENT 'æ“ä½œçš„è®°å½•ID',
    old_value JSON COMMENT 'æ—§å€¼',
    new_value JSON COMMENT 'æ–°å€¼',
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_created (user_id, created_at),
    INDEX idx_table_record (table_name, record_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01'))
);
```

### è®¾è®¡è¦ç‚¹

1. **åˆ†è¡¨ç­–ç•¥**ï¼šæŒ‰æœˆåˆ†è¡¨ï¼ŒæŸ¥è¯¢æ—¶è·¯ç”±åˆ°å¯¹åº”æœˆä»½çš„è¡¨
2. **åˆ†åŒºè¡¨**ï¼šMySQL 5.7+ æ”¯æŒåˆ†åŒºï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–
3. **å‡å°‘ç´¢å¼•**ï¼šåªä¿ç•™æŸ¥è¯¢å¿…éœ€çš„ç´¢å¼•
4. **JSON å­—æ®µ**ï¼šä½¿ç”¨ JSON å­˜å‚¨æ–°æ—§å€¼ï¼Œçµæ´»ä½†æŸ¥è¯¢æ€§èƒ½ç•¥å·®ï¼ˆé€‚åˆæ—¥å¿—åœºæ™¯ï¼‰

### å®é™…åº”ç”¨

```sql
-- å†™å…¥æ—¥å¿—ï¼ˆè·¯ç”±åˆ°å¯¹åº”æœˆä»½çš„è¡¨ï¼‰
-- åº”ç”¨å±‚æ ¹æ®å½“å‰æ—¶é—´å†³å®šå†™å…¥å“ªå¼ è¡¨
INSERT INTO operation_logs_202401
(user_id, operation_type, table_name, record_id, old_value, new_value, ip_address)
VALUES (?, ?, ?, ?, ?, ?, ?);

-- æŸ¥è¯¢æ—¥å¿—ï¼ˆéœ€è¦æŸ¥è¯¢å¤šå¼ è¡¨ï¼‰
SELECT * FROM operation_logs_202401
WHERE user_id = ? AND created_at >= '2024-01-01' AND created_at < '2024-02-01'
UNION ALL
SELECT * FROM operation_logs_202402
WHERE user_id = ? AND created_at >= '2024-02-01' AND created_at < '2024-03-01';

-- æˆ–è€…ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å†™å…¥
-- 1. æ—¥å¿—å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis/RabbitMQï¼‰
// producer.send('log_queue', logData);

-- 2. æ¶ˆè´¹è€…æ‰¹é‡å†™å…¥æ•°æ®åº“
INSERT INTO operation_logs_202401 (...) VALUES (...), (...), (...);
```

### æŒæ¡èƒ½åŠ›

å­¦ä¹ å®Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ï¼š

1. **é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–**ï¼šç†è§£å¦‚ä½•é€šè¿‡åˆ†è¡¨ã€å‡å°‘ç´¢å¼•ã€å¼‚æ­¥å†™å…¥ä¼˜åŒ–é«˜å¹¶å‘å†™å…¥æ€§èƒ½
2. **åˆ†è¡¨ç­–ç•¥**ï¼šæŒæ¡æŒ‰æ—¶é—´åˆ†è¡¨çš„ç­–ç•¥ï¼Œä»¥åŠå¦‚ä½•è·¯ç”±æŸ¥è¯¢åˆ°æ­£ç¡®çš„è¡¨
3. **åˆ†åŒºè¡¨ä½¿ç”¨**ï¼šäº†è§£ MySQL åˆ†åŒºè¡¨çš„ä½¿ç”¨åœºæ™¯å’Œè¯­æ³•
4. **ç´¢å¼•æƒè¡¡**ï¼šç†è§£åœ¨å†™å…¥é¢‘ç¹çš„åœºæ™¯ä¸‹ï¼Œå¦‚ä½•æƒè¡¡ç´¢å¼•æ•°é‡å’ŒæŸ¥è¯¢æ€§èƒ½
5. **å¼‚æ­¥å¤„ç†**ï¼šæŒæ¡ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²å†™å…¥ï¼Œæ‰¹é‡å¤„ç†æé«˜æ€§èƒ½

**åº”ç”¨åœºæ™¯**ï¼šæ—¥å¿—ç³»ç»Ÿã€æ“ä½œå®¡è®¡ã€è¡Œä¸ºè¿½è¸ªã€ä»»ä½•é«˜å¹¶å‘å†™å…¥çš„åœºæ™¯

---

## æ€»ç»“

### è®¾è®¡æ€è·¯æ€»ç»“

é€šè¿‡ä»¥ä¸Š 7 ä¸ªå®æˆ˜æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ï¼š

1. **è®¢å•å¿«ç…§**ï¼šä¸šåŠ¡éœ€æ±‚ä¼˜å…ˆï¼Œå¿…è¦æ—¶å¯ä»¥è¿åèŒƒå¼åŒ–
2. **æ ‘å½¢ç»“æ„**ï¼šæ ¹æ®æŸ¥è¯¢åœºæ™¯é€‰æ‹©åˆé€‚çš„è®¾è®¡æ–¹æ¡ˆï¼ˆé‚»æ¥è¡¨/è·¯å¾„æšä¸¾/é—­åŒ…è¡¨ï¼‰
3. **å…³ç³»è®¾è®¡**ï¼šä½¿ç”¨è¯­ä¹‰æ˜ç¡®çš„å­—æ®µåï¼Œé¿å…æ··æ·†
4. **è¿›åº¦è®¾è®¡**ï¼šæ±‡æ€»è¡¨ + æ˜ç»†è¡¨ï¼Œå…¼é¡¾æŸ¥è¯¢æ€§èƒ½å’Œè¯¦ç»†ä¿¡æ¯
5. **çŠ¶æ€æµè½¬**ï¼šå½“å‰çŠ¶æ€ + å†å²è¡¨ï¼Œè®°å½•å®Œæ•´å˜æ›´é“¾
6. **å¤šç§Ÿæˆ·**ï¼šæ‰€æœ‰è¡¨æ·»åŠ  `tenant_id`ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
7. **é«˜å¹¶å‘å†™å…¥**ï¼šåˆ†è¡¨ + å‡å°‘ç´¢å¼• + å¼‚æ­¥å†™å…¥

### æ ¸å¿ƒåŸåˆ™

-   âœ… **ä¸šåŠ¡ä¼˜å…ˆ**ï¼šè®¾è®¡æœåŠ¡äºä¸šåŠ¡éœ€æ±‚ï¼Œä¸æ˜¯æ•™æ¡åœ°éµå¾ªç†è®º
-   âœ… **æ€§èƒ½å¹³è¡¡**ï¼šåœ¨æŸ¥è¯¢æ€§èƒ½å’Œå­˜å‚¨ç©ºé—´ä¹‹é—´æ‰¾åˆ°å¹³è¡¡
-   âœ… **å†—ä½™åˆç†**ï¼šåˆç†ä½¿ç”¨å†—ä½™å­—æ®µï¼Œé¿å…é¢‘ç¹ JOIN å’Œç»Ÿè®¡æŸ¥è¯¢
-   âœ… **ç´¢å¼•é€‚åº¦**ï¼šç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®æŸ¥è¯¢åœºæ™¯è®¾è®¡
-   âœ… **æ‰©å±•è€ƒè™‘**ï¼šè®¾è®¡æ—¶è€ƒè™‘æœªæ¥æ‰©å±•ï¼Œä½†ä¸è¿‡åº¦è®¾è®¡

**è®°ä½**ï¼šæ•°æ®åº“è®¾è®¡æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œåªæœ‰æœ€é€‚åˆå½“å‰ä¸šåŠ¡åœºæ™¯çš„æ–¹æ¡ˆã€‚å¤šå®è·µã€å¤šæ€è€ƒã€å¤šæ€»ç»“ï¼
