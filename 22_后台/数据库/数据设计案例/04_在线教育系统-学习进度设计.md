# 案例 4：在线教育系统 - 学习进度设计

## 需求场景

学生购买课程后，需要记录：

-   每个章节的学习进度（已学习/未学习）
-   每个视频的观看时长
-   课程的整体学习进度百分比
-   最后学习位置（断点续播）

## 第一次设计（错误）

```sql
-- 只记录课程学习状态
CREATE TABLE course_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    progress_percent INT DEFAULT 0 COMMENT '学习进度百分比',
    last_study_time TIMESTAMP,
    UNIQUE KEY (user_id, course_id)
);
```

**问题**：

1. 无法知道具体哪个章节已学习
2. 无法记录视频观看时长
3. 进度百分比计算不准确

## 设计思路

**核心问题**：需要同时记录整体进度和明细进度。

**解决方案**：采用"汇总表 + 明细表"的设计模式。

## 最终设计

```sql
-- 1. 课程学习进度汇总表
CREATE TABLE course_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    total_chapters INT DEFAULT 0 COMMENT '总章节数',
    completed_chapters INT DEFAULT 0 COMMENT '已完成章节数',
    progress_percent DECIMAL(5,2) DEFAULT 0 COMMENT '学习进度百分比',
    last_chapter_id BIGINT COMMENT '最后学习的章节ID',
    last_study_time TIMESTAMP COMMENT '最后学习时间',
    completed_at TIMESTAMP NULL COMMENT '完成时间',
    UNIQUE KEY uk_user_course (user_id, course_id),
    INDEX idx_user_id (user_id),
    INDEX idx_course_id (course_id)
);

-- 2. 章节学习进度明细表
CREATE TABLE chapter_progress (
    progress_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    chapter_id BIGINT NOT NULL,
    status TINYINT DEFAULT 0 COMMENT '0:未学习 1:学习中 2:已完成',
    study_duration INT DEFAULT 0 COMMENT '学习时长（秒）',
    last_position INT DEFAULT 0 COMMENT '最后观看位置（秒）',
    completed_at TIMESTAMP NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES courses(course_id),
    FOREIGN KEY (chapter_id) REFERENCES chapters(chapter_id),
    UNIQUE KEY uk_user_chapter (user_id, course_id, chapter_id),
    INDEX idx_user_course (user_id, course_id),
    INDEX idx_chapter_id (chapter_id)
);
```

## 设计要点

1. **汇总表 + 明细表**：汇总表快速查询整体进度，明细表记录详细信息
2. **冗余字段**：`course_id` 在明细表中冗余，避免 JOIN 查询
3. **进度计算**：`progress_percent = (completed_chapters / total_chapters) * 100`
4. **断点续播**：`last_position` 记录视频观看位置

## 实际应用

```sql
-- 更新章节学习进度
UPDATE chapter_progress
SET status = 2, completed_at = NOW(), study_duration = study_duration + ?
WHERE user_id = ? AND chapter_id = ?;

-- 同步更新课程整体进度
UPDATE course_progress cp
SET
    completed_chapters = (
        SELECT COUNT(*) FROM chapter_progress
        WHERE user_id = cp.user_id
        AND course_id = cp.course_id
        AND status = 2
    ),
    progress_percent = ROUND(
        (completed_chapters / total_chapters) * 100,
        2
    ),
    last_chapter_id = ?,
    last_study_time = NOW()
WHERE user_id = ? AND course_id = ?;
```

## 掌握能力

学习完这个案例，你将掌握：

1. **汇总表+明细表模式**：理解何时需要同时设计汇总表和明细表，兼顾查询性能和详细信息
2. **进度计算设计**：掌握如何设计学习进度、完成度等百分比计算字段
3. **冗余字段使用**：学会在明细表中冗余存储 `course_id` 等字段，避免频繁 JOIN
4. **断点续播设计**：理解如何设计 `last_position` 等字段支持断点续播功能
5. **数据同步策略**：掌握如何同步更新汇总表和明细表的数据

**应用场景**：在线教育、学习进度、任务完成度、项目进度、任何需要记录明细和汇总的场景

