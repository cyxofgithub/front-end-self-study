# 案例 3：社交系统 - 关注关系设计

## 需求场景

用户 A 关注用户 B，需要支持：

-   查询 A 关注了谁（关注列表）
-   查询谁关注了 A（粉丝列表）
-   判断 A 是否关注了 B
-   查询 A 和 B 是否互相关注

## 第一次设计（错误）

```sql
CREATE TABLE follows (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    follow_user_id BIGINT NOT NULL COMMENT '关注的用户ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (user_id, follow_user_id)
);
```

**问题**：字段命名不清晰，`user_id` 和 `follow_user_id` 容易混淆，查询时需要思考哪个是关注者。

## 设计思路

**核心问题**：如何清晰地表示"谁关注了谁"？

**解决方案**：使用语义明确的字段名，区分关注者和被关注者。

## 最终设计

```sql
CREATE TABLE follows (
    follow_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    follower_id BIGINT NOT NULL COMMENT '关注者ID（粉丝）',
    following_id BIGINT NOT NULL COMMENT '被关注者ID（博主）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (follower_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (following_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE KEY uk_follower_following (follower_id, following_id),
    INDEX idx_follower_id (follower_id) COMMENT '查询关注列表',
    INDEX idx_following_id (following_id) COMMENT '查询粉丝列表'
);
```

## 设计要点

1. **语义明确的字段名**：`follower_id`（粉丝）关注 `following_id`（博主）
2. **唯一约束**：防止重复关注
3. **双向索引**：`idx_follower_id` 用于查询关注列表，`idx_following_id` 用于查询粉丝列表

## 实际应用

```sql
-- 查询用户A的关注列表（A关注了谁）
SELECT u.* FROM users u
JOIN follows f ON u.user_id = f.following_id
WHERE f.follower_id = ?;

-- 查询用户A的粉丝列表（谁关注了A）
SELECT u.* FROM users u
JOIN follows f ON u.user_id = f.follower_id
WHERE f.following_id = ?;

-- 判断A是否关注了B
SELECT COUNT(*) FROM follows
WHERE follower_id = ? AND following_id = ?;

-- 查询互相关注（需要JOIN两次）
SELECT f1.follower_id, f1.following_id
FROM follows f1
JOIN follows f2 ON f1.follower_id = f2.following_id
    AND f1.following_id = f2.follower_id;
```

## 掌握能力

学习完这个案例，你将掌握：

1. **关系表设计**：掌握如何设计清晰的关系表，使用语义明确的字段名
2. **双向查询优化**：理解如何为双向查询（关注列表/粉丝列表）设计合适的索引
3. **唯一约束设计**：学会使用复合唯一约束防止重复关系
4. **复杂关系查询**：掌握如何查询互相关注等复杂关系
5. **字段命名规范**：理解好的字段命名（`follower_id`/`following_id`）如何提高代码可读性

**应用场景**：社交系统、关注/粉丝关系、好友关系、点赞关系、收藏关系、任何双向关系场景

