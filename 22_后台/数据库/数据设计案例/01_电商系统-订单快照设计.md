# 案例 1：电商系统 - 订单快照设计

## 需求场景

用户下单后，商品信息可能会变更（价格调整、名称修改、下架等），但历史订单必须保持下单时的商品信息不变。

## 第一次设计（错误）

```sql
-- 订单明细表
CREATE TABLE order_items (
    item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,  -- 只存商品ID
    quantity INT NOT NULL,
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);
```

**问题**：当商品价格从 100 元改为 80 元后，查询历史订单时，显示的价格是 80 元，而不是下单时的 100 元。

## 设计思路

**核心问题**：订单数据需要"快照"功能，记录下单时的商品信息。

**解决方案**：在订单明细表中冗余存储商品信息快照。

## 最终设计

```sql
-- 订单明细表（存储快照）
CREATE TABLE order_items (
    item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,  -- 保留商品ID，便于关联查询
    product_name VARCHAR(200) NOT NULL COMMENT '快照：下单时的商品名称',
    product_price DECIMAL(10,2) NOT NULL COMMENT '快照：下单时的商品价格',
    product_image VARCHAR(255) COMMENT '快照：下单时的商品图片',
    quantity INT NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL COMMENT '小计 = product_price * quantity',
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id),
    INDEX idx_order_id (order_id),
    INDEX idx_product_id (product_id)
);
```

## 设计要点

1. **冗余存储快照**：虽然违反了范式化原则，但这是业务需求，必须冗余
2. **保留商品 ID**：方便后续关联查询商品详情、库存等
3. **小计字段**：预计算 `quantity * product_price`，避免每次查询都计算

## 实际应用

```sql
-- 创建订单时，需要同时插入快照数据
INSERT INTO order_items (order_id, product_id, product_name, product_price, quantity, subtotal)
SELECT
    ? as order_id,
    product_id,
    product_name,  -- 从商品表获取
    price,         -- 从商品表获取
    ? as quantity,
    price * ? as subtotal
FROM products
WHERE product_id = ?;
```

## 掌握能力

学习完这个案例，你将掌握：

1. **识别快照需求**：能够识别哪些业务场景需要数据快照（订单、合同、账单等）
2. **合理冗余设计**：理解何时应该违反范式化原则，为了业务需求进行合理的冗余存储
3. **快照实现技巧**：掌握在创建订单时如何从源表获取数据并存储快照
4. **预计算字段**：学会使用预计算字段（如 `subtotal`）避免每次查询都进行计算
5. **业务优先思维**：理解数据库设计应该服务于业务需求，而不是教条地遵循理论

**应用场景**：订单系统、合同系统、账单系统、任何需要记录历史状态的业务场景

