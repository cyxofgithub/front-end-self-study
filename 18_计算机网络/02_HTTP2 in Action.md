# 第 4 章 HTTP/2 协议基础

## 与 HTTP/1 的区别

### **HTTP/2是一个二进制的、基于数据包的协议，而HTTP/1是完全基于文本的**。

- **使用基于文本的协议，要先发完请求，并接收完响应之后，才能开始下一个请求**。HTTP在过去的20年里都是这种工作方式，只有一些小的改进。例如，HTTP/1.0引入了二进制的HTTP消息体，支持在响应中发送图片或其他媒体文件。HTTP/1.1引入了管道化（见第2章）和分块编码。分块编码允许先发送消息体的一部分，当其余的部分可用时再接着发。这时HTTP消息体被分成多个块，客户端可以在完整收到所有数据之前就开始处理这些分块的内容（服务端也可以收到分块请求）。这个技术常用于数据长度动态生成的场景，预先不知道总数据长度。分块编码和管道化都有队头阻塞（HOL）的问题——在队列首部的消息会阻塞后面消息的发送，更不用说，管道化在实际应用中并没
- HTTP/2变成了一个完全的二进制协议，HTTP消息被分成清晰定义的数据帧发送。这里的帧和支撑HTTP连接的TCP数据包类似。当收到所有的数据帧后，可以将它们组合为完整的HTTP消息。所有的HTTP/2消息都使用分块的编码技术。

### **HTTP/2 中多路复用代替同步请求**

- HTTP/2使用多个二进制帧发送HTTP请求和响应，使用单个TCP连接，以流的方式多路复用。
- HTTP/1是一种同步的、独占的请求-响应协议。客户端发送HTTP/1消息，然后服务器返回HTTP/1响应。
- HTTP/2允许在单个连接上同时执行多个请求，每个HTTP请求或响应使用不同的流。通过使用二进制分帧层，给每个帧分配一个流标识符，以支持同时发出多个独立请求。当接收到该流的所有帧时，接收方可以将帧组合成完整消息
- 帧是同时发送多个消息的关键。每个帧都有标签表明它属于哪个消息（流），这样在一个连接上就可以同时有两个、三个甚至上百个消息。不像在HTTP/1中，大多数浏览器只能并发6个请求

### **HTTP/2 中的流的优先级和流量控制**

- HTTP/2连接在请求发出后不需要阻塞到响应返回。服务器发送响应的顺序完全取决于服务器，但客户端可以指定优先级。如果可以发送多个响应，则服务器可以进行优先级排序，先发送重要资源（例如CSS和JavaScript），然后是不太重要的资源（例如图像）。
- 现在HTTP/2对并发的请求数量的限制放宽了很多（在许多实现中，默认情况下允许同时存在100个活跃的流），因此许多请求不再需要浏览器来排队，可以立即发送它们。这可能导致带宽浪费在较低优先级的资源（例如图像）上，从而导致在HTTP/2下页面的加载速度变慢。所以需要控制流的优先级，使用更高的优先级发送最关键的资源。
  - 流的优先级控制是通过这种方式实现的：当数据帧在排队时，服务器会给高优先级的请求发送更多的帧。
- 流量控制是在同一个连接上使用多个流的另一种方式。如果接收方处理消息的速度慢于发送方，就会存在积压，需要将数据放入缓冲区。而当缓冲区满时会导致丢包，需要重新发送。在连接层，TCP支持限流，但HTTP/2要在流的层面实现流量控制。以视频网页为例。如果用户暂停视频，可以仅暂停视频流，允许加载网站的其他资源，这是更好的选择。

### 首部压缩

- 响应首部可能会有重复（user-agent、cookie、Host、Accept、Accept-Encoding），会很浪费资源。有些特殊的响应首部，如CSP（Content Security Policy）首部，可能会很大，也可能会有重复。这对于小的请求来说特别糟糕，在这种情况下，HTTP首部将占下载资源的很大一部分。
- HTTP/2引入了首部压缩的概念，但是它使用了和正文压缩不同的技术。该技术支持跨请求压缩首部，这可以避免正文压缩所使用算法的安全问题。

### 服务端推送

HTTP/2添加了服务端推送的概念，它允许服务端给一个请求返回多个响应



