# 小型办公网络拓扑 + 数据包流转全流程演示

我们以 **10 人小型办公室** 场景为例，设计包含**路由器、二层交换机、VLAN 划分**的基础网络，同时详细拆解「办公 PC 访问外网网站」的数据包转发步骤。

## 一、网络拓扑结构（核心设备与配置）

### 1. 设备清单与角色

| 设备类型        | 数量 | 核心配置                                                                                                                                                                 | 作用定位                          |
| --------------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------- |
| 企业级路由器    | 1 台 | WAN 口：公网 IP `202.100.50.10`（运营商分配）<br>LAN 口：内网网关 `192.168.1.1/24` <br>开启 NAT、默认路由（指向运营商网关）                                              | 出口网关、跨网路由、NAT 转换      |
| 二层网管交换机  | 1 台 | 划分 2 个 VLAN：<br>VLAN10（办公区）：端口 1-8，网段 `192.168.1.0/24` <br>VLAN20（服务器区）：端口 9-10，网段 `192.168.2.0/24` <br>上行端口（Trunk 口）连接路由器 LAN 口 | 内网设备接入、VLAN 隔离、数据交换 |
| 办公 PC（终端） | 8 台 | 示例：PC1 地址 `192.168.1.10/24`，网关 `192.168.1.1`                                                                                                                     | 员工办公终端                      |
| 办公服务器      | 2 台 | 示例：Server1 地址 `192.168.2.20/24`，网关 `192.168.1.1`                                                                                                                 | 文件/打印服务器                   |
| 外网目标服务器  | -    | 示例：百度服务器 IP `180.101.50.242`                                                                                                                                     | 外网访问目标                      |

### 2. 拓扑连接示意图

```
[运营商网络] ——WAN口—— [企业路由器] ——LAN口（Trunk）—— [二层交换机]
                                                          │
                                 ┌────────────────────────┴────────────────────────┐
                                 │                                                 │
                          [VLAN10 办公PC1-PC8]                           [VLAN20 服务器1-2]
```

## 二、关键前置配置（确保网络连通）

1.  **路由器配置**

    -   配置 WAN 口 IP（运营商提供的公网 IP），并添加**默认路由**：`0.0.0.0/0 → 运营商网关IP`（如 `202.100.50.1`）。
    -   配置 LAN 口 IP 为 `192.168.1.1/24`，并开启**NAT 功能**（将内网私有 IP 转换为公网 IP）。
    -   配置**静态路由**：`192.168.2.0/24 → 交换机Trunk口`，确保能访问 VLAN20 的服务器网段。

2.  **交换机配置**
    -   创建 VLAN10 和 VLAN20，将对应端口划入指定 VLAN。
    -   将连接路由器的上行端口配置为**Trunk 口**，允许 VLAN10 和 VLAN20 的流量通过。
    -   关闭非必要端口，防止非法设备接入。

## 三、数据包流转全流程（以 PC1 访问百度为例）

我们将整个过程拆分为 **7 个核心步骤**，覆盖「内网交换 → 路由转发 → 外网返回」的完整链路。

### 步骤 1：PC1 发起访问请求（生成数据包）

-   PC1 浏览器输入 `www.baidu.com`，首先通过 DNS 解析获取百度服务器的公网 IP `180.101.50.242`。
-   PC1 对比目标 IP `180.101.50.242` 与自身网段 `192.168.1.0/24`，发现**不在同一网段**，因此将数据包发送给**默认网关 `192.168.1.1`**。
-   PC1 封装数据包：
    -   **三层头部**：源 IP `192.168.1.10`，目标 IP `180.101.50.242`。
    -   **二层头部**：源 MAC `PC1的MAC地址`，目标 MAC `路由器LAN口的MAC地址`（通过 ARP 协议获取）。

### 步骤 2：交换机接收并转发数据包（二层交换）

-   PC1 通过网线将数据包发送到交换机的 VLAN10 端口（如端口 1）。
-   交换机收到数据包后，**检查二层头部的目标 MAC 地址**，查询自身的 **MAC 地址表**。
-   由于交换机已通过 ARP 学习到路由器 LAN 口的 MAC 地址对应的端口是「Trunk 上行口」，因此直接将数据包从 Trunk 口转发到路由器。
-   关键特性：交换机仅在 VLAN10 内转发，不会扩散到其他 VLAN，实现广播域隔离。

### 步骤 3：路由器接收数据包，执行 NAT 转换（三层路由）

-   路由器从 LAN 口（Trunk 口）接收数据包，**剥离二层头部**，检查三层头部的目标 IP。
-   路由器查询**路由表**，发现目标 IP `180.101.50.242` 是外网地址，匹配默认路由（指向运营商网关）。
-   路由器执行 **NAT 转换**：将内网源 IP `192.168.1.10` 替换为自身 WAN 口的公网 IP `202.100.50.10`，并在 NAT 表中记录映射关系 `（192.168.1.10:端口号 → 202.100.50.10:端口号）`，用于后续返回数据包的反向转换。

### 步骤 4：路由器转发数据包到运营商网络（公网路由）

-   路由器重新封装数据包：
    -   **三层头部**：源 IP `202.100.50.10`（公网 IP），目标 IP `180.101.50.242`。
    -   **二层头部**：源 MAC `路由器WAN口MAC`，目标 MAC `运营商网关MAC`（通过 ARP 获取）。
-   路由器通过 WAN 口将数据包发送到运营商网关，运营商网络通过骨干网路由将数据包转发到百度服务器。

### 步骤 5：百度服务器响应并返回数据包

-   百度服务器接收数据包，处理请求后生成响应数据包：
    -   **三层头部**：源 IP `180.101.50.242`，目标 IP `202.100.50.10`（路由器公网 IP）。
-   响应数据包通过运营商骨干网反向路由，最终发送到路由器的 WAN 口。

### 步骤 6：路由器接收响应包，执行 NAT 反向转换

-   路由器从 WAN 口接收响应数据包，检查**NAT 表**，根据目标 IP `202.100.50.10` 和端口号，匹配到内网源主机 `192.168.1.10`。
-   路由器执行 **NAT 反向转换**：将目标 IP 从 `202.100.50.10` 改回 `192.168.1.10`。
-   路由器重新封装二层头部：目标 MAC `PC1的MAC地址`，源 MAC `路由器LAN口MAC地址`。

### 步骤 7：交换机将响应包转发到 PC1

-   路由器通过 Trunk 口将响应数据包发送到交换机。
-   交换机检查数据包的 VLAN 标识（属于 VLAN10），查询 MAC 地址表，找到 PC1 对应的端口（端口 1），将数据包精准转发到 PC1。
-   PC1 接收数据包，浏览器解析后展示百度页面，整个访问流程完成。

## 四、核心协同关键点总结

1.  **交换机管“内网转发”**：基于 MAC 地址和 VLAN 实现高速、隔离的二层交换，不关心 IP 地址。
2.  **路由器管“跨网路由”**：基于 IP 地址和路由表实现三层转发，通过 NAT 解决内网私有 IP 访问公网的问题。
3.  **Trunk 口是关键桥梁**：交换机的 Trunk 口允许多个 VLAN 的流量通过，实现路由器与多个内网网段的连通。

需要我提供这个场景下**路由器和交换机的具体配置命令**（以 Cisco 设备为例）吗？
